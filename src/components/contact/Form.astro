---
// =====================================================
// TRANSUNIFYY CONTACT FORM (No Captcha Version)
// =====================================================
// 
// CONFIGURATION: Update these 2 values from Supabase Dashboard
// Go to: Supabase Dashboard → Settings → API
//
// =====================================================

// Fundations
import Text from "@/components/fundations/elements/Text.astro";
import Kicker from "@/components/fundations/elements/Kicker.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
// Icons
import MapPin from "@/components/fundations/icons/MapPin.astro";
import Phone from "@/components/fundations/icons/Phone.astro";
import Envelpe from "@/components/fundations/icons/Envelope.astro";

// =====================================================
// ⚙️ SUPABASE CONFIGURATION - UPDATE THESE 2 VALUES
// =====================================================
const SUPABASE_URL = "https://uwewbhohctnscldfhtpu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3ZXdiaG9oY3Ruc2NsZGZodHB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NjkyMzAsImV4cCI6MjA2ODI0NTIzMH0.aQR5CeOuyh1S26rM6Bu9XzA7yxGfQeCkqjfDQndA-kM";
// =====================================================

// Contact Details
const contactDetails = {
  email: "contact@transunifyy.com",
  phone: "+91 75175 60123",
  address: "Flat No. T02/1101, SN 183/203\nKapil Malhar Intelligent, Baner Gaon\nHaveli, Pune - 411045\nMaharashtra, India",
};

const contactItems = [
  {
    label: "Address",
    value: contactDetails.address.split("\n"),
    icon: "location",
  },
  {
    label: "Phone",
    value: [contactDetails.phone],
    href: `tel:${contactDetails.phone.replace(/[^\d+]/g, "")}`,
    icon: "phone",
  },
  {
    label: "Email",
    value: [contactDetails.email],
    href: `mailto:${contactDetails.email}`,
    icon: "mail",
  },
];
---

<section>
  <Wrapper variant="standard" class="py-24">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      
      <!-- Left Column: Contact Info -->
      <div>
        <Kicker class="text-accent-600">Get in touch</Kicker>
        <Text
          tag="h2"
          variant="displaySM"
          class="font-medium tracking-tight text-base-900 mt-12 text-balance"
        >
          Connect with our social impact experts today.
        </Text>
        <Text tag="p" variant="textLG" class="text-base-600 mt-4">
          Whether you have a question about our services, need details about impact assessment, or want to discuss a potential collaboration for social good—we're here to help.
        </Text>
        
        <!-- Contact Items -->
        <div class="mt-12 space-y-8 border-t border-base-200 pt-8">
          {
            contactItems.map((item) => (
              <div class="flex items-start gap-4">
                <span class="flex size-10 items-center justify-center rounded-full bg-accent-500/10 text-accent-600">
                  {item.icon === "location" ? (
                    <MapPin size="sm" class="text-accent-500" />
                  ) : item.icon === "phone" ? (
                    <Phone size="sm" class="text-accent-500" />
                  ) : (
                    <Envelpe size="sm" class="text-accent-500" />
                  )}
                </span>
                <div class="space-y-1">
                  <Text tag="p" variant="textBase" class="font-medium text-base-900">
                    {item.label}
                  </Text>
                  <Text tag="p" variant="textBase" class="text-base-700 leading-relaxed">
                    {item.value.map((line, index) => (
                      <>
                        {item.href ? (
                          <a
                            href={Array.isArray(item.href) ? item.href[index] || item.href[0] : item.href}
                            class="transition-colors hover:text-accent-500"
                          >
                            {line}
                          </a>
                        ) : (
                          line
                        )}
                        {index < item.value.length - 1 ? <br /> : ""}
                      </>
                    ))}
                  </Text>
                </div>
              </div>
            ))
          }
        </div>
        
        <!-- Office Hours & CIN -->
        <div class="mt-8 pt-8 border-t border-base-200">
          <Text tag="p" variant="textSM" class="text-base-500">
            <span class="font-medium text-base-700">Office Hours:</span> Monday – Saturday, 9:00 AM – 6:00 PM IST
          </Text>
          <Text tag="p" variant="textSM" class="text-base-500 mt-1">
            <span class="font-medium text-base-700">CIN:</span> U70200PN2025PTC238486
          </Text>
        </div>
      </div>
      
      <!-- Right Column: Contact Form -->
      <div class="bg-accent-950 rounded-lg p-8">
        
        <!-- Form -->
        <form id="contact-form">
          <h3 class="text-lg font-medium tracking-tight text-white">
            Send us a message
          </h3>
          <p class="text-base text-base-400 mt-1">
            Fill out the form and our team will reach out within one business day.
          </p>
          
          <div class="space-y-4 mt-8">
            
            <!-- Name (Required) -->
            <div class="space-y-2">
              <label for="contact-name" class="text-sm text-base-400 block">
                Name<span class="text-accent-500">*</span>
              </label>
              <input
                id="contact-name"
                type="text"
                name="name"
                required
                autocomplete="name"
                placeholder="Your full name"
                class="w-full rounded border border-white/15 bg-accent-950 px-4 py-3 h-12 text-white placeholder:text-base-600 focus:border-accent-500 focus:ring-2 focus:ring-accent-500 transition-all focus:outline-none"
              />
            </div>
            
            <!-- Mobile Number (Required) -->
            <div class="space-y-2">
              <label for="contact-mobile" class="text-sm text-base-400 block">
                Mobile Number<span class="text-accent-500">*</span>
              </label>
              <input
                id="contact-mobile"
                type="tel"
                name="mobile"
                required
                inputmode="numeric"
                maxlength="15"
                autocomplete="tel"
                placeholder="Your mobile number"
                class="w-full rounded border border-white/15 bg-accent-950 px-4 py-3 h-12 text-white placeholder:text-base-600 focus:border-accent-500 focus:ring-2 focus:ring-accent-500 transition-all focus:outline-none"
              />
              <p id="mobile-error" class="text-red-400 text-xs hidden">
                Please enter a valid mobile number (minimum 10 digits)
              </p>
            </div>
            
            <!-- Email (Optional) -->
            <div class="space-y-2">
              <label for="contact-email" class="text-sm text-base-400 block">
                Email
              </label>
              <input
                id="contact-email"
                type="email"
                name="email"
                autocomplete="email"
                placeholder="Your email address"
                class="w-full rounded border border-white/15 bg-accent-950 px-4 py-3 h-12 text-white placeholder:text-base-600 focus:border-accent-500 focus:ring-2 focus:ring-accent-500 transition-all focus:outline-none"
              />
            </div>
            
            <!-- Organization Name (Optional) -->
            <div class="space-y-2">
              <label for="contact-organization" class="text-sm text-base-400 block">
                Organization Name
              </label>
              <input
                id="contact-organization"
                type="text"
                name="organization"
                autocomplete="organization"
                placeholder="Your company or organization"
                class="w-full rounded border border-white/15 bg-accent-950 px-4 py-3 h-12 text-white placeholder:text-base-600 focus:border-accent-500 focus:ring-2 focus:ring-accent-500 transition-all focus:outline-none"
              />
            </div>
            
            <!-- Message (Optional) -->
            <div class="space-y-2">
              <label for="contact-message" class="text-sm text-base-400 block">
                Message
              </label>
              <textarea
                id="contact-message"
                name="message"
                rows="4"
                placeholder="Tell us about your requirements..."
                class="w-full rounded border border-white/15 bg-accent-950 px-4 py-3 text-white placeholder:text-base-600 focus:border-accent-500 focus:ring-2 focus:ring-accent-500 transition-all focus:outline-none resize-none"
              ></textarea>
            </div>
          </div>

          <!-- Error Message -->
          <div id="form-error" class="hidden mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded text-red-300 text-sm">
            Something went wrong. Please try again.
          </div>

          <!-- Submit Button -->
          <button 
            type="submit" 
            id="submit-btn"
            class="w-full mt-6 bg-white text-accent-950 font-medium py-3 px-6 rounded hover:bg-base-100 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            <span id="btn-text">Submit</span>
            <svg id="btn-spinner" class="hidden animate-spin h-5 w-5" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </form>
        
        <!-- Thank You Message (Hidden by default) -->
        <div id="thank-you-message" class="hidden text-center py-8">
          <div class="flex justify-center mb-6">
            <div class="w-20 h-20 bg-accent-500/20 rounded-full flex items-center justify-center">
              <svg class="w-10 h-10 text-accent-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>
          <h3 class="text-2xl font-semibold text-white mb-3">
            Thank You!
          </h3>
          <p class="text-base-400 mb-2">
            Your message has been received successfully.
          </p>
          <p class="text-base-500 text-sm mb-6">
            Our team will get back to you within one business day.
          </p>
          <div id="email-confirmation" class="hidden text-sm text-accent-500 mb-6">
            ✓ Confirmation email sent to your inbox
          </div>
          <button 
            type="button" 
            id="reset-form-btn"
            class="text-accent-500 hover:text-accent-400 underline text-sm transition-colors"
          >
            Send another message
          </button>
        </div>
      </div>
    </div>
  </Wrapper>
</section>

<script define:vars={{ SUPABASE_URL, SUPABASE_ANON_KEY }}>
  // ===== DOM ELEMENTS =====
  const form = document.getElementById('contact-form');
  const mobileInput = document.getElementById('contact-mobile');
  const mobileError = document.getElementById('mobile-error');
  const thankYouMessage = document.getElementById('thank-you-message');
  const emailConfirmation = document.getElementById('email-confirmation');
  const resetBtn = document.getElementById('reset-form-btn');
  const submitBtn = document.getElementById('submit-btn');
  const btnText = document.getElementById('btn-text');
  const btnSpinner = document.getElementById('btn-spinner');
  const formError = document.getElementById('form-error');

  // ===== MOBILE VALIDATION (Numbers Only) =====
  mobileInput?.addEventListener('input', (e) => {
    const target = e.target;
    // Remove non-numeric characters
    target.value = target.value.replace(/[^0-9]/g, '');
    
    if (target.value.length >= 10) {
      mobileError?.classList.add('hidden');
    }
  });

  mobileInput?.addEventListener('blur', () => {
    if (mobileInput.value.length > 0 && mobileInput.value.length < 10) {
      mobileError?.classList.remove('hidden');
    }
  });

  // ===== UI HELPERS =====
  function setLoading(loading) {
    if (submitBtn) submitBtn.disabled = loading;
    if (btnText) btnText.textContent = loading ? 'Submitting...' : 'Submit';
    btnSpinner?.classList.toggle('hidden', !loading);
  }

  function showError(message) {
    if (formError) {
      formError.textContent = message;
      formError.classList.remove('hidden');
    }
  }

  function hideError() {
    formError?.classList.add('hidden');
  }

  // ===== FORM SUBMISSION =====
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();

    // Validate mobile number
    if (mobileInput && mobileInput.value.length < 10) {
      mobileError?.classList.remove('hidden');
      mobileInput.focus();
      return;
    }

    setLoading(true);

    // Collect form data
    const formData = new FormData(form);
    const data = {
      name: formData.get('name'),
      mobile: formData.get('mobile'),
      email: formData.get('email') || null,
      organization: formData.get('organization') || null,
      message: formData.get('message') || null,
      source_page: window.location.pathname,
      referrer: document.referrer || null,
    };

    try {
      // ===== STEP 1: Insert into Supabase Table =====
      const insertResponse = await fetch(`${SUPABASE_URL}/rest/v1/website_contacts`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(data)
      });

      if (!insertResponse.ok) {
        const errorText = await insertResponse.text();
        console.error('Insert error:', errorText);
        throw new Error('Failed to save your message');
      }

      const [insertedRecord] = await insertResponse.json();
      console.log('✅ Contact saved:', insertedRecord?.id);

      // ===== STEP 2: Call Edge Function to Send Email =====
      if (data.email) {
        try {
          const emailResponse = await fetch(`${SUPABASE_URL}/functions/v1/send-contact-email`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            },
            body: JSON.stringify({ ...data, id: insertedRecord?.id })
          });

          if (emailResponse.ok) {
            console.log('✅ Email sent');
            emailConfirmation?.classList.remove('hidden');
          } else {
            console.warn('⚠️ Email sending failed, but form was saved');
          }
        } catch (emailError) {
          console.warn('⚠️ Email error:', emailError);
          // Don't fail the form submission if email fails
        }
      }

      // Show success message
      form.classList.add('hidden');
      thankYouMessage?.classList.remove('hidden');

    } catch (error) {
      console.error('Form submission error:', error);
      showError('Something went wrong. Please try again or contact us directly at +91 75175 60123.');
    } finally {
      setLoading(false);
    }
  });

  // ===== RESET FORM =====
  resetBtn?.addEventListener('click', () => {
    form.reset();
    form.classList.remove('hidden');
    thankYouMessage?.classList.add('hidden');
    emailConfirmation?.classList.add('hidden');
    hideError();
  });
</script>